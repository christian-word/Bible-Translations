<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Библейский компаратор | Сравнение переводов Библии</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ======================================
    Стили из интерфейс.html (Оставлены как в оригинале)
    ======================================
    */
    :root {
      --primary: #2c3e50;
      --primary-dark: #1a252f;
      --primary-light: #3498db;
      --secondary: #8e44ad;
      --accent: #e74c3c;
      --success: #27ae60;
      --text: #2c3e50;
      --text-light: #7f8c8d;
      --text-lighter: #95a5a6;
      --border: #ecf0f1;
      --bg: #f9f9f9;
      --bg-light: #f8fafc;
      --bg-dark: #f1f5f9;
      --shadow: rgba(0, 0, 0, 0.08);
      --radius: 8px;
      --radius-sm: 4px;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.6;
      margin: 0;
      padding: 0;
      transition: background-color 0.3s, color 0.3s;
    }

    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
    }

    /* Навигация */
    .bible-navigation {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      padding: 15px 0;
      background: var(--bg-light);
      border-bottom: 1px solid var(--border);
      border-top-left-radius: var(--radius);
      border-top-right-radius: var(--radius);
      align-items: center;
    }

    .nav-group {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0 15px;
    }

    .chapter-nav {
      justify-content: flex-end;
    }

    .select-group {
      justify-content: flex-start;
      grid-column: 1 / 2;
    }

    select, button {
      padding: 10px 15px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 16px;
      cursor: pointer;
      background-color: white;
      color: var(--text);
      transition: all 0.2s;
    }

    select:focus, button:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    button {
      background-color: var(--primary);
      color: white;
      font-weight: bold;
    }

    button:hover {
      background-color: var(--primary-dark);
    }

    /* Контейнер переводов */
    #translationsContainer {
      background-color: var(--bg-card, white);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-top: 20px;
    }
    
    .translation-selector {
        margin-bottom: 20px;
    }
    
    .translation-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 20px;
        border: 1px solid var(--border);
        padding: 15px;
        border-radius: var(--radius-sm);
        background: var(--bg-light);
    }
    
    .translation-option {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
    }

    .translation-option input[type="checkbox"] {
        appearance: none;
        width: 18px;
        height: 18px;
        border: 2px solid var(--primary);
        border-radius: var(--radius-sm);
        cursor: pointer;
        position: relative;
        transition: background-color 0.2s, border-color 0.2s;
    }

    .translation-option input[type="checkbox"]:checked {
        background-color: var(--primary);
        border-color: var(--primary);
    }
    
    .translation-option label {
        cursor: pointer;
        user-select: none;
    }

    /* Сетка сравнения */
    #comparisonGrid {
      display: grid;
      gap: 1px; /* Разделитель между ячейками */
      background-color: var(--border); /* Цвет разделителя */
      margin-top: 15px;
      border-radius: var(--radius-sm);
      overflow: hidden;
      width: 100%;
    }

    .header-row {
      display: contents; /* Позволяет дочерним элементам быть элементами сетки */
    }

    .header-cell {
      background-color: var(--primary);
      color: white;
      padding: 12px 8px;
      font-weight: bold;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .verse-row {
      display: contents;
    }

    .verse-num-cell, .verse-text-cell {
      padding: 12px 8px;
      background-color: white;
      border-bottom: 1px solid var(--border);
    }

    .verse-num-cell {
      font-weight: bold;
      text-align: center;
      background-color: var(--bg-light);
      color: var(--accent);
      position: sticky;
      left: 0;
      z-index: 5;
    }
    
    .verse-text-number {
        display: none; /* Скрыто на десктопе */
    }

    .verse-row:nth-child(odd) .verse-text-cell {
      background-color: var(--bg-light);
    }

    /* Заголовок модального окна (он же - главный заголовок) */
    #modalTitle {
      font-size: 1.8rem;
      color: var(--primary-dark);
      text-align: center;
      margin-top: 20px;
      margin-bottom: 20px;
    }

    /* Загрузка */
    .loading {
      text-align: center;
      padding: 50px 0;
      color: var(--text-light);
      font-size: 1.1rem;
    }

    .loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-top: 4px solid var(--primary-light);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Пустое состояние */
    .empty-state {
        text-align: center;
        padding: 50px 20px;
        color: var(--text-light);
        font-size: 1.1rem;
        border: 2px dashed var(--border);
        border-radius: var(--radius);
        margin: 20px 0;
    }
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        color: var(--text-lighter);
    }
    
    /* Стили для секции загрузки файла */
    .file-upload-section {
        padding: 1.5rem; 
        border: 1px dashed var(--border); 
        border-radius: var(--radius); 
        margin-bottom: 2rem; 
        background: var(--bg-light);
    }
    
    .navigation-title {
        font-weight: bold;
        color: var(--primary-dark);
        margin-bottom: 10px;
        font-size: 1.1rem;
    }


    /* Медиа-запросы для мобильных устройств */
    @media (max-width: 900px) {
        .container {
            margin: 0;
            padding: 0;
        }

        .bible-navigation {
            grid-template-columns: 1fr;
            gap: 10px;
            padding: 10px;
        }

        .nav-group {
            padding: 0;
            justify-content: center;
        }
        
        .select-group {
            grid-column: auto;
            flex-wrap: wrap;
        }

        select {
            flex-grow: 1;
        }
        
        #comparisonGrid {
            display: block; /* Сброс сетки на блочную модель */
            gap: 0;
            margin-top: 0;
            border-radius: 0;
        }
        
        .header-row, .verse-num-cell {
            display: none; /* Скрытие заголовков и колонки стихов */
        }

        .verse-text-cell {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            position: relative;
        }
        
        .verse-text-number {
            display: inline-block; /* Показать номер стиха на мобильных */
            font-weight: bold;
            color: var(--accent);
            margin-right: 8px;
            position: absolute;
            top: 15px;
            left: 5px;
            font-size: 0.8em;
            background: var(--bg);
            padding: 3px 5px;
            border-radius: var(--radius-sm);
        }
        
        .verse-text-cell:before {
            content: attr(data-translation-name);
            display: block;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .verse-text-cell {
            margin-top: 10px; /* Отступ между переводами */
        }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="bible-navigation">
      <div class="nav-group select-group">
        <select id="bookSelect" title="Выберите книгу"></select>
        <select id="chapterSelect" title="Выберите главу"></select>
      </div>
      <div class="nav-group chapter-nav">
        <button id="prevChapter" title="Предыдущая глава"><i class="fas fa-arrow-left"></i> Назад</button>
        <button id="nextChapter" title="Следующая глава">Вперед <i class="fas fa-arrow-right"></i></button>
      </div>
    </div>

    <div class="file-upload-section">
        <div class="navigation-title"><i class="fas fa-upload"></i> Загрузить свой перевод (JSON)</div>
        <input type="file" id="translationFileInput" accept=".json" style="display: block; width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: white;">
        <p style="margin-top: 10px; font-size: 0.9em; color: var(--text-light);">После загрузки файл появится в списке для выбора. Файл должен быть в формате, совместимом с приложением.</p>
    </div>
    <h3 id="modalTitle">Загрузка...</h3>

    <div id="translationsContainer">
      <div class="translation-selector">
        <h4>Выберите переводы:</h4>
        <div id="translationCheckboxes" class="translation-options">
          </div>
      </div>
      
      <div id="verseContent">
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>Ожидание загрузки локальных данных...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- КОНСТАНТЫ И ОСНОВНЫЕ ДАННЫЕ ---
    const STORAGE_KEY_TRANSLATIONS = 'bibleComparator_selectedTranslations';
    const STORAGE_KEY_BOOK = 'bibleComparator_currentBook';
    const STORAGE_KEY_CHAPTER = 'bibleComparator_currentChapter';
    
    let currentBookIndex = 0;
    let currentChapter = 1;

    // --- ЛОКАЛЬНОЕ ХРАНИЛИЩЕ ДАННЫХ ---
    // Формат: {CODE: {BookName: {ChapterNum: {VerseNum: "Text"}}}}
    const LOCAL_DATA = {}; 

    // Список доступных переводов (изначально пустой, если не загружать встроенные файлы)
    let AVAILABLE_TRANSLATIONS = [
        { name: "Синодальный (SYNOD)", code: "SYNOD" },
        { name: "Перевод Кулакова (KULAKOV)", code: "KULAKOV" },
        { name: "Новый Русский (NRT)", code: "NRT" },
        { name: "Украинская Библия (UBIO)", code: "UBIO" },
        { name: "Перевод Кассиана (KASSIAN)", code: "KASSIAN" }
    ]; 

    const BIBLE_BOOKS = [
        // Ваши 66 книг Библии
        { name: "Бытие", chapters: 50, abbr: "Быт" },
        { name: "Исход", chapters: 40, abbr: "Исх" },
        { name: "Левит", chapters: 27, abbr: "Лев" },
        { name: "Числа", chapters: 36, abbr: "Чис" },
        { name: "Второзаконие", chapters: 34, abbr: "Втор" },
        { name: "Иисус Навин", chapters: 24, abbr: "Нав" },
        { name: "Судей", chapters: 21, abbr: "Суд" },
        { name: "Руфь", chapters: 4, abbr: "Руфь" },
        { name: "1 Царств", chapters: 31, abbr: "1Цар" },
        { name: "2 Царств", chapters: 24, abbr: "2Цар" },
        { name: "3 Царств", chapters: 22, abbr: "3Цар" },
        { name: "4 Царств", chapters: 25, abbr: "4Цар" },
        { name: "1 Паралипоменон", chapters: 29, abbr: "1Пар" },
        { name: "2 Паралипоменон", chapters: 36, abbr: "2Пар" },
        { name: "Ездры", chapters: 10, abbr: "Ездр" },
        { name: "Неемии", chapters: 13, abbr: "Неем" },
        { name: "Есфирь", chapters: 10, abbr: "Есф" },
        { name: "Иов", chapters: 42, abbr: "Иов" },
        { name: "Псалтирь", chapters: 150, abbr: "Пс" },
        { name: "Притчи", chapters: 31, abbr: "Притч" },
        { name: "Екклесиаст", chapters: 12, abbr: "Еккл" },
        { name: "Песнь Песней", chapters: 8, abbr: "Песн" },
        { name: "Исаии", chapters: 66, abbr: "Ис" },
        { name: "Иеремии", chapters: 52, abbr: "Иер" },
        { name: "Плач Иеремии", chapters: 5, abbr: "Плач" },
        { name: "Иезекииля", chapters: 48, abbr: "Иез" },
        { name: "Даниила", chapters: 12, abbr: "Дан" },
        { name: "Осии", chapters: 14, abbr: "Ос" },
        { name: "Иоиля", chapters: 3, abbr: "Иоил" },
        { name: "Амоса", chapters: 9, abbr: "Ам" },
        { name: "Авдия", chapters: 1, abbr: "Авд" },
        { name: "Ионы", chapters: 4, abbr: "Ион" },
        { name: "Михея", chapters: 7, abbr: "Мих" },
        { name: "Наума", chapters: 3, abbr: "Наум" },
        { name: "Аввакума", chapters: 3, abbr: "Авв" },
        { name: "Софонии", chapters: 3, abbr: "Соф" },
        { name: "Аггея", chapters: 2, abbr: "Агг" },
        { name: "Захарии", chapters: 14, abbr: "Зах" },
        { name: "Малахии", chapters: 4, abbr: "Мал" },
        { name: "От Матфея", chapters: 28, abbr: "Мф" },
        { name: "От Марка", chapters: 16, abbr: "Мк" },
        { name: "От Луки", chapters: 24, abbr: "Лк" },
        { name: "От Иоанна", chapters: 21, abbr: "Ин" },
        { name: "Деяния", chapters: 28, abbr: "Деян" },
        { name: "К Римлянам", chapters: 16, abbr: "Рим" },
        { name: "1 Коринфянам", chapters: 16, abbr: "1Кор" },
        { name: "2 Коринфянам", chapters: 13, abbr: "2Кор" },
        { name: "К Галатам", chapters: 6, abbr: "Гал" },
        { name: "К Ефесянам", chapters: 6, abbr: "Еф" },
        { name: "К Филиппийцам", chapters: 4, abbr: "Флп" },
        { name: "К Колоссянам", chapters: 4, abbr: "Кол" },
        { name: "1 Фессалоникийцам", chapters: 5, abbr: "1Фес" },
        { name: "2 Фессалоникийцам", chapters: 3, abbr: "2Фес" },
        { name: "1 Тимофею", chapters: 6, abbr: "1Тим" },
        { name: "2 Тимофею", chapters: 4, abbr: "2Тим" },
        { name: "К Титу", chapters: 3, abbr: "Тит" },
        { name: "К Филимону", chapters: 1, abbr: "Флм" },
        { name: "К Евреям", chapters: 13, abbr: "Евр" },
        { name: "Иакова", chapters: 5, abbr: "Иак" },
        { name: "1 Петра", chapters: 5, abbr: "1Пет" },
        { name: "2 Петра", chapters: 3, abbr: "2Пет" },
        { name: "1 Иоанна", chapters: 5, abbr: "1Ин" },
        { name: "2 Иоанна", chapters: 1, abbr: "2Ин" },
        { name: "3 Иоанна", chapters: 1, abbr: "3Ин" },
        { name: "Иуды", chapters: 1, abbr: "Иуд" },
        { name: "Откровение", chapters: 22, abbr: "Откр" }
    ]; 
    
    // --- DOM-ЭЛЕМЕНТЫ (Использование getElementById) ---
    const modalTitle = document.getElementById('modalTitle'); 
    const verseContent = document.getElementById('verseContent'); 
    const bookSelect = document.getElementById('bookSelect'); 
    const chapterSelect = document.getElementById('chapterSelect'); 
    const translationCheckboxesContainer = document.getElementById('translationCheckboxes');
    // Обязательное получение нового элемента для загрузки
    const translationFileInput = document.getElementById('translationFileInput');

    // --- ФУНКЦИИ ЗАГРУЗКИ ЛОКАЛЬНОГО ФАЙЛА ---

    function getSelectedTranslations() {
        const checkboxes = translationCheckboxesContainer.querySelectorAll('input[type="checkbox"]:checked');
        return Array.from(checkboxes).map(cb => cb.value);
    }

    /**
     * Добавляет данные перевода из загруженного файла в LOCAL_DATA.
     * Ожидается JSON-формат: {"CODE": {"BookName": {"ChapterNum": {"VerseNum": "Text"}}}}
     */
    function addTranslationToLocalData(data) {
        // Получаем код перевода (первый ключ в объекте)
        const translationCode = Object.keys(data)[0];
        if (!translationCode) {
            alert("Ошибка: Неверный формат файла. Не найден код перевода.");
            return;
        }
        
        // Проверка и добавление в список доступных переводов
        const existingTranslation = AVAILABLE_TRANSLATIONS.find(t => t.code === translationCode);
        if (!existingTranslation) {
            const newTranslationName = prompt(`Введите название для нового перевода с кодом "${translationCode}":`, translationCode);
            if (newTranslationName) {
                AVAILABLE_TRANSLATIONS.push({ name: newTranslationName, code: translationCode, custom: true });
            } else {
                return; // Пользователь отменил ввод
            }
        }
        
        // Добавляем/обновляем данные в LOCAL_DATA
        Object.assign(LOCAL_DATA, data);
        
        // Перерисовываем чекбоксы и загружаем представление
        initializeTranslationCheckboxes(); 
        loadComparisonView();
        alert(`Перевод "${AVAILABLE_TRANSLATIONS.find(t => t.code === translationCode)?.name || translationCode}" успешно загружен!`);
    }

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const content = e.target.result;
                let data = JSON.parse(content);
                addTranslationToLocalData(data);
            } catch (error) {
                console.error("Ошибка при обработке файла:", error);
                alert("Ошибка при чтении или разборе файла. Убедитесь, что это корректный JSON-файл.");
            }
        };
        reader.readAsText(file);
    }

    // --- ФУНКЦИИ ИНИЦИАЛИЗАЦИИ И НАВИГАЦИИ ---

    function initializeTranslationCheckboxes() {
        const container = translationCheckboxesContainer;
        container.innerHTML = '';
        const fragment = document.createDocumentFragment();

        let savedTranslations = [];
        try {
            const saved = localStorage.getItem(STORAGE_KEY_TRANSLATIONS);
            if (saved) savedTranslations = JSON.parse(saved);
        } catch (e) {
            savedTranslations = [];
        }
        const defaultTranslations = savedTranslations.length > 0 ? savedTranslations : ["SYNOD", "UBIO"];

        AVAILABLE_TRANSLATIONS.forEach(t => {
            // Проверяем наличие данных
            const isDisabled = !LOCAL_DATA[t.code]; 
            
            const div = document.createElement('div');
            div.className = 'translation-option';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = t.code;
            checkbox.id = `cb-${t.code}`;
            checkbox.setAttribute('role', 'switch');
            
            if (isDisabled) {
                checkbox.disabled = true;
                div.style.opacity = 0.5;
                div.title = "Данные для этого перевода не загружены.";
            }

            if (!isDisabled && defaultTranslations.includes(t.code)) { 
                checkbox.checked = true;
            }
            
            checkbox.addEventListener('change', loadComparisonView);
            
            const label = document.createElement('label');
            label.setAttribute('for', `cb-${t.code}`);
            label.textContent = t.name + (isDisabled ? ' (НЕТ ДАННЫХ)' : '');
            
            div.appendChild(checkbox);
            div.appendChild(label);
            fragment.appendChild(div);
        });
        container.appendChild(fragment);
    }
    
    // Асинхронная функция загрузки и отображения сравнения (ИСПОЛЬЗУЕТ LOCAL_DATA)
    async function loadComparisonView() {
        const selectedTranslations = getSelectedTranslations();
        const book = BIBLE_BOOKS[currentBookIndex];
        const bookName = book.name;
        const chapterNum = currentChapter.toString();

        // 1. Обновление URL и localStorage
        const urlParams = new URLSearchParams();
        urlParams.set('book', book.abbr);
        urlParams.set('chapter', currentChapter);
        urlParams.set('translations', selectedTranslations.join(','));
        history.pushState({ book: book.abbr, chapter: currentChapter, translations: selectedTranslations }, '', `?${urlParams.toString()}`);
        localStorage.setItem(STORAGE_KEY_BOOK, currentBookIndex);
        localStorage.setItem(STORAGE_KEY_CHAPTER, currentChapter);
        localStorage.setItem(STORAGE_KEY_TRANSLATIONS, JSON.stringify(selectedTranslations));

        const titleTranslations = selectedTranslations
            .map(code => AVAILABLE_TRANSLATIONS.find(t => t.code === code)?.name || code)
            .join(' / ');
        modalTitle.textContent = `${book.name}, глава ${currentChapter} | Сравнение: ${titleTranslations || 'Нет переводов'}`;

        if (selectedTranslations.length === 0) {
            verseContent.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-hand-pointer"></i>
                    <p>Выберите хотя бы один перевод для сравнения выше.</p>
                    <p>Или загрузите файл перевода, если нужного нет в списке.</p>
                </div>
            `;
            return;
        }

        verseContent.innerHTML = `
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Подготовка текста для сравнения...</p>
            </div>
        `;

        // 2. Сбор данных из LOCAL_DATA
        const versesMap = new Map();
        let verseNumbers = new Set();
        let dataFound = false;

        selectedTranslations.forEach(code => {
            const bookData = LOCAL_DATA[code]?.[bookName];
            if (bookData && bookData[chapterNum]) {
                dataFound = true;
                const chapterData = bookData[chapterNum];
                
                Object.keys(chapterData).forEach(verseNum => {
                    const text = chapterData[verseNum];
                    verseNumbers.add(parseInt(verseNum));
                    
                    if (!versesMap.has(verseNum)) {
                        versesMap.set(verseNum, new Map());
                    }
                    
                    versesMap.get(verseNum).set(code, {
                        verse: parseInt(verseNum),
                        translation: code,
                        text: text
                    });
                });
            }
        });
        
        if (!dataFound && LOCAL_DATA) {
            verseContent.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Данные для ${book.name}, главы ${currentChapter} не найдены в загруженных переводах.</p>
                </div>
            `;
            updateNavButtons();
            return;
        }
        
        // 3. Рендеринг
        const sortedVerseNumbers = Array.from(verseNumbers).sort((a, b) => a - b);
        const colCount = selectedTranslations.length;
        let html = `<div id="comparisonGrid" role="table" style="grid-template-columns: 80px repeat(${colCount}, 1fr);">`;

        // Заголовки столбцов
        html += '<div class="header-row" role="rowgroup">';
        html += `<div class="header-cell verse-num" role="columnheader">Стих</div>`;
        selectedTranslations.forEach(code => {
            const name = AVAILABLE_TRANSLATIONS.find(t => t.code === code)?.name || code;
            html += `<div class="header-cell translation-name" role="columnheader">${name.split(' (')[0]}</div>`;
        });
        html += '</div>';

        // Строки стихов
        sortedVerseNumbers.forEach(verseNum => {
            const verseNumStr = verseNum.toString();
            html += '<div class="verse-row" role="row">';
            html += `<div class="verse-num-cell verse-num" role="rowheader">${verseNumStr}</div>`;
            
            selectedTranslations.forEach(code => {
                const verseData = versesMap.get(verseNumStr)?.get(code);
                const name = AVAILABLE_TRANSLATIONS.find(t => t.code === code)?.name || code;
                let text = '<span style="color: var(--text-light); font-style: italic;">(Нет текста)</span>';

                if (verseData && verseData.text) {
                    text = DOMPurify.sanitize(verseData.text);
                }

                html += `<div class="verse-text-cell" role="cell" data-translation-name="${name.split(' (')[0]}">`;
                html += `<span class="verse-text-number">${verseNumStr}</span>`; 
                html += text;
                html += `</div>`;
            });
            html += '</div>';
        });

        html += '</div>';
        verseContent.innerHTML = html;
        updateNavButtons();
    }
    
    // Вспомогательные функции навигации
    function updateChapterSelector() {
        const book = BIBLE_BOOKS[currentBookIndex];
        chapterSelect.innerHTML = '';
        for (let i = 1; i <= book.chapters; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            chapterSelect.appendChild(option);
        }
        chapterSelect.value = currentChapter;
    }

    function goToPrevChapter() {
        if (currentChapter > 1) {
            currentChapter--;
        } else if (currentBookIndex > 0) {
            currentBookIndex--;
            currentChapter = BIBLE_BOOKS[currentBookIndex].chapters;
            bookSelect.value = currentBookIndex;
        }
        updateChapterSelector();
        loadComparisonView();
    }

    function goToNextChapter() {
        const book = BIBLE_BOOKS[currentBookIndex];
        if (currentChapter < book.chapters) {
            currentChapter++;
        } else if (currentBookIndex < BIBLE_BOOKS.length - 1) {
            currentBookIndex++;
            currentChapter = 1;
            bookSelect.value = currentBookIndex;
        }
        updateChapterSelector();
        loadComparisonView();
    }
    
    function updateNavButtons() {
        const book = BIBLE_BOOKS[currentBookIndex];
        const prevChapterBtn = document.getElementById('prevChapter');
        const nextChapterBtn = document.getElementById('nextChapter');

        // Кнопка "Назад"
        if (currentBookIndex === 0 && currentChapter === 1) {
            prevChapterBtn.disabled = true;
            prevChapterBtn.style.opacity = 0.5;
        } else {
            prevChapterBtn.disabled = false;
            prevChapterBtn.style.opacity = 1;
        }

        // Кнопка "Вперед"
        if (currentBookIndex === BIBLE_BOOKS.length - 1 && currentChapter === book.chapters) {
            nextChapterBtn.disabled = true;
            nextChapterBtn.style.opacity = 0.5;
        } else {
            nextChapterBtn.disabled = false;
            nextChapterBtn.style.opacity = 1;
        }
    }

    // --- ФУНКЦИЯ ИНИЦИАЛИЗАЦИИ ---

    document.addEventListener('DOMContentLoaded', initializeBibleSelector);
    
    function initializeBibleSelector() {
        // --- 1. Восстановление состояния из URL или localStorage ---
        let initialBookIndex = parseInt(localStorage.getItem(STORAGE_KEY_BOOK)) || 0;
        let initialChapter = parseInt(localStorage.getItem(STORAGE_KEY_CHAPTER)) || 1;

        const urlParams = new URLSearchParams(window.location.search);
        const urlBookAbbr = urlParams.get('book');
        const urlChapter = parseInt(urlParams.get('chapter'));

        if (urlBookAbbr) {
            const bookIndexFromAbbr = BIBLE_BOOKS.findIndex(b => b.abbr === urlBookAbbr);
            if (bookIndexFromAbbr !== -1) {
                initialBookIndex = bookIndexFromAbbr;
                if (urlChapter && urlChapter >= 1 && urlChapter <= BIBLE_BOOKS[initialBookIndex].chapters) {
                    initialChapter = urlChapter;
                } else {
                    initialChapter = 1;
                }
            }
        }
        currentBookIndex = initialBookIndex;
        currentChapter = initialChapter;
        
        // --- 2. Заполнение селектора книг ---
        BIBLE_BOOKS.forEach((book, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = book.name;
            bookSelect.appendChild(option);
        });
        bookSelect.value = currentBookIndex;

        // --- 3. Инициализация флажков переводов ---
        initializeTranslationCheckboxes(); 

        // --- 4. Обработчик для загрузки файла ---
        // ИСПРАВЛЕННЫЙ ВЫЗОВ: используем уже определенную переменную translationFileInput
        if (translationFileInput) {
            translationFileInput.addEventListener('change', handleFileUpload);
        } else {
            console.error("Элемент #translationFileInput не найден.");
        }
        
        // --- 5. Обработчики событий навигации ---
        bookSelect.addEventListener('change', function() {
            currentBookIndex = parseInt(this.value);
            currentChapter = 1; 
            updateChapterSelector();
            loadComparisonView();
        });
        
        chapterSelect.addEventListener('change', function() {
            currentChapter = parseInt(this.value);
            loadComparisonView();
        });
        
        document.getElementById('prevChapter').addEventListener('click', goToPrevChapter);
        document.getElementById('nextChapter').addEventListener('click', goToNextChapter);
        
        // Обработка кнопки "Назад/Вперед" в браузере
        window.addEventListener('popstate', function(event) {
            const state = event.state;
            if (state) {
                const bookIndexFromAbbr = BIBLE_BOOKS.findIndex(b => b.abbr === state.book);
                if (bookIndexFromAbbr !== -1) {
                    currentBookIndex = bookIndexFromAbbr;
                    bookSelect.value = currentBookIndex;
                }
                currentChapter = state.chapter;
                chapterSelect.value = currentChapter;
                updateChapterSelector(); 
                loadComparisonView(); 
            }
        });

        // --- 6. Начальная загрузка ---
        updateChapterSelector();
        loadComparisonView();
    }
  </script>
</body>
</html>